import requests
from bs4 import BeautifulSoup
from docx import Document
from datetime import datetime
import matplotlib.pyplot as plt
from collections import Counter
from urllib.parse import urljoin

# URL новостного сайта
url = "https://lenta.ru/"

# Задание заголовков, включая User-Agent
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
}

# Получаем HTML-код страницы
response = requests.get(url, headers=headers)
html_content = response.content

# Создаем объект BeautifulSoup для парсинга HTML
soup = BeautifulSoup(html_content, 'html.parser')

# Извлекаем новости
articles = soup.find_all('a', class_='card-big _slider _partners _news')

news_data = []

for article in articles:
    title_tag = article.find('h3', class_='card-big__title')
    link_tag = article.get('href')
    time_tag = article.find('time', class_='card-big__date')

    if title_tag and link_tag:
        title = title_tag.get_text(strip=True)
        link = urljoin(url, link_tag)
        time_text = time_tag.get_text(strip=True) if time_tag else 'No date'

        # Добавляем информацию в список
        news_data.append({
            "title": title,
            "link": link,
            "time_text": time_text
        })

# Создание Word файла
doc = Document()
doc.add_heading('Новости Lenta', 0)

for news in news_data:
    doc.add_heading(news["title"], level=1)
    doc.add_paragraph(f"Link: {news['link']}")
    doc.add_paragraph(f"Time: {news['time_text']}")

doc.save("news_data.docx")

print("Данные успешно сохранены в файл news_data.docx")

# Функция для извлечения месяца из строки даты
def extract_month(date_str):
    try:
        # Преобразуем строку в datetime объект
        date_obj = datetime.strptime(date_str, '%d %b %Y')
        return date_obj.strftime('%Y-%m')
    except ValueError:
        return 'июль'

# Подготовка данных для построения графика
months = [extract_month(news["time_text"]) for news in news_data]

# Фильтрация 'Unknown' значений
filtered_months = [month for month in months if month != 'Unknown']

# Подготовка данных для построения графика
months = [extract_month(news["time_text"]) for news in news_data]

# Группируем по месяцам
date_counts = Counter(months)

# Подготовка данных для графика
month_labels = sorted(date_counts.keys())
counts = [date_counts[month] for month in month_labels]

# Построение графика
plt.figure(figsize=(10, 5))
plt.bar(month_labels, counts, color='skyblue')
plt.xlabel('Месяц')
plt.ylabel('Количество новостей')
plt.title('Количество новостей, публикуемых на сайте Lenta.ru по месяцам')
plt.xticks(rotation=45)
plt.tight_layout()
plt.savefig('news_count_per_month.png')
plt.show()

print("График успешно сохранен в файл news_count_per_month.png")
